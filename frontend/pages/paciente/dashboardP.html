<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Paciente - Agenda Interactiva</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">

<style>
body {
    font-family: 'Roboto Condensed', sans-serif;
    background-color: #f4f1ea;
    margin: 0;
    padding: 0;
}

.navbar { background-color: #93c1e2; }
.navbar-brand { color: #ffffff; font-size: 1.5rem; font-weight: bold; }
.navbar-brand:hover { color: #e0e0e0; }

#calendar {
    max-width: 1100px; 
    margin: 20px auto; 
    background: white; 
    padding: 20px; 
    border-radius: 10px; 
    box-shadow: 0px 2px 15px rgba(0,0,0,0.1);
}

.fc-event-title { display:flex; align-items:center; }
.event-img { width:25px; height:25px; border-radius:50%; margin-right:5px; object-fit:cover; }
.popover { max-width: 260px; }
#misCitas { max-width:1100px; margin: 20px auto; }

.btn { background-color: #007bff !important; border-color: #007bff !important; color: white !important; }
.btn:hover { background-color: #0056b3 !important; border-color: #0056b3 !important; }
</style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container-fluid">
        <a class="navbar-brand">Citas Médicas SENA</a>
    </div>
</nav>

<div class="container my-4">
    <h1 class="text-center">Dashboard Paciente</h1>

    <div class="mb-3">
        <label for="medicoSelect" class="form-label">Seleccione un médico:</label>
        <select id="medicoSelect" class="form-select"></select>
    </div>

    <div id="calendar"></div>

    <h3 class="mt-4 text-danger">Mis Citas Agendadas</h3>
    <ul class="list-group" id="misCitas"></ul>

    <div id="alertaAgendar"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

<script>
const medicos = [
  {id: 1, nombre: 'Dr. Juan Pérez', especialidad: 'Cardiología', horarios: ['09:00','10:00','11:00'], img: 'https://randomuser.me/api/portraits/men/32.jpg'},
  {id: 2, nombre: 'Dra. María López', especialidad: 'Dermatología', horarios: ['10:00','11:00','12:00'], img: 'https://randomuser.me/api/portraits/women/44.jpg'},
  {id: 3, nombre: 'Dr. Carlos Ruiz', especialidad: 'Pediatría', horarios: ['08:00','09:30','11:30'], img: 'https://randomuser.me/api/portraits/men/65.jpg'}
];

let citas = [];

const medicoSelect = document.getElementById('medicoSelect');
medicos.forEach(m => {
  const option = document.createElement('option');
  option.value = m.id;
  option.textContent = `${m.nombre} - ${m.especialidad}`;
  medicoSelect.appendChild(option);
});

medicoSelect.addEventListener('change', () => calendar.refetchEvents());

const calendarEl = document.getElementById('calendar');
const calendar = new FullCalendar.Calendar(calendarEl, {
  initialView: 'timeGridWeek',
  locale: 'es',
  slotMinTime: '07:00:00',
  slotMaxTime: '18:00:00',
  selectable: true,
  allDaySlot: false,
  headerToolbar: {
    left: 'prev,next today',
    center: 'title',
    right: 'dayGridMonth,timeGridWeek,timeGridDay'
  },
  events: function(fetchInfo, successCallback) {
    const medicoId = parseInt(medicoSelect.value);
    if(!medicoId){ successCallback([]); return; }

    const medico = medicos.find(m => m.id === medicoId);

    // Citas ocupadas
    const events = citas
      .filter(c => c.medicoId === medicoId)
      .map(c => ({
        title: c.medicoNombre,
        start: c.fecha+'T'+c.horario,
        end: c.fecha+'T'+c.horario,
        color: '#6c757d',
        extendedProps: { img: c.img, especialidad: c.especialidad, horario: c.horario }
      }));

    // Horarios libres
    const dias = [];
    const start = new Date(fetchInfo.start);
    const end = new Date(fetchInfo.end);
    for(let d=start; d<end; d.setDate(d.getDate()+1)){
      dias.push(d.toISOString().split('T')[0]);
    }

    dias.forEach(dia=>{
      medico.horarios.forEach(h=>{
        const ocupada = events.find(e => e.start.substring(0,16) === dia+'T'+h);
        if(!ocupada){
          events.push({
            title: 'Libre',
            start: dia+'T'+h,
            end: dia+'T'+h,
            color: '#007bff', // ahora libre en azul
            extendedProps: { img: medico.img, especialidad: medico.especialidad, horario: h, medicoNombre: medico.nombre, medicoId: medico.id }
          });
        }
      });
    });

    successCallback(events);
  },
  eventContent: function(arg){
    const imgUrl = arg.event.extendedProps.img;
    const especialidad = arg.event.extendedProps.especialidad;
    const horario = arg.event.extendedProps.horario;
    return { html: `<img src="${imgUrl}" class="event-img"/> ${arg.event.title} <small>(${especialidad} - ${horario})</small>` };
  },
  eventDidMount: function(info){
    if(info.event.title==='Libre'){
      const content = `
        <div class="card p-2">
          <img src="${info.event.extendedProps.img}" class="card-img-top mb-2" style="width:50px; height:50px; border-radius:50%; object-fit:cover;">
          <div class="card-body p-1">
            <h6 class="card-title mb-1">${info.event.extendedProps.medicoNombre}</h6>
            <p class="card-text mb-1"><small>${info.event.extendedProps.especialidad}</small></p>
            <p class="card-text mb-1"><small>Hora: ${info.event.extendedProps.horario}</small></p>
            <button class="btn btn-primary w-100 btnAgendar">Agendar Cita</button>
          </div>
        </div>
      `;
      const popover = new bootstrap.Popover(info.el, {
        trigger: 'click',
        html: true,
        content: content,
        placement: 'top',
        sanitize: false
      });

      info.el.addEventListener('click', ()=>{
        setTimeout(()=>{
          const btn = document.querySelector('.btnAgendar');
          if(btn){
            btn.addEventListener('click', ()=>{
              citas.push({
                medicoId: info.event.extendedProps.medicoId,
                medicoNombre: info.event.extendedProps.medicoNombre,
                especialidad: info.event.extendedProps.especialidad,
                fecha: info.event.startStr.substring(0,10),
                horario: info.event.extendedProps.horario,
                img: info.event.extendedProps.img
              });
              info.event.setProp('color','#6c757d'); // ocupado en gris
              info.event.setProp('title', info.event.extendedProps.medicoNombre);
              popover.dispose();
              actualizarListaCitas();
              document.getElementById('alertaAgendar').innerHTML = `<div class="alert alert-success mt-2">Cita agendada con ${info.event.extendedProps.medicoNombre} a las ${info.event.extendedProps.horario}</div>`;
              setTimeout(()=>document.getElementById('alertaAgendar').innerHTML='',4000);
            });
          }
        },100);
      });
    }
  },
  eventClick: function(info){
    if(info.event.title!=='Libre'){
      if(confirm(`¿Desea cancelar la cita con ${info.event.title}?`)){
        const index = citas.findIndex(c => c.medicoNombre === info.event.title && c.fecha+'T'+c.horario === info.event.startStr.substring(0,16));
        if(index>=0) citas.splice(index,1);
        info.event.setProp('color','#007bff'); // vuelve a libre azul
        info.event.setProp('title','Libre');
        actualizarListaCitas();
      }
    }
  }
});

calendar.render();

function actualizarListaCitas(){
  const lista = document.getElementById('misCitas');
  lista.innerHTML = '';
  citas.forEach((c,index)=>{
    const li = document.createElement('li');
    li.className = 'list-group-item d-flex justify-content-between align-items-center';
    li.innerHTML = `
      ${c.medicoNombre} - ${c.especialidad} - ${c.fecha} ${c.horario}
      <div>
        <button class="btn btn-sm btn-primary me-1 btnModificar">Modificar</button>
        <button class="btn btn-sm btn-primary btnEliminar">Eliminar</button>
      </div>
    `;
    li.querySelector('.btnModificar').addEventListener('click', ()=>{
      const nuevaHora = prompt('Ingrese la nueva hora (HH:MM):', c.horario);
      const nuevaFecha = prompt('Ingrese la nueva fecha (YYYY-MM-DD):', c.fecha);
      if(nuevaHora && nuevaFecha){
        c.horario = nuevaHora;
        c.fecha = nuevaFecha;
        calendar.refetchEvents();
        actualizarListaCitas();
      }
    });
    li.querySelector('.btnEliminar').addEventListener('click', ()=>{
      if(confirm('¿Desea eliminar esta cita?')){
        citas.splice(index,1);
        calendar.refetchEvents();
        actualizarListaCitas();
      }
    });
    lista.appendChild(li);
  });
}
</script>

</body>
</html>
