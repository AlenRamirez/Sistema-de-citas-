<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administrador - Sistema de Citas Médicas</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }

        .sidebar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            min-height: 100vh;
            box-shadow: 2px 0 20px rgba(0, 0, 0, 0.1);
        }

        .nav-link {
            color: #333 !important;
            border-radius: 10px;
            margin: 5px 0;
            transition: all 0.3s ease;
        }

        .nav-link:hover,
        .nav-link.active {
            background: linear-gradient(45deg, #1e3c72, #2a5298);
            color: white !important;
            transform: translateX(5px);
        }

        .main-content {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            margin: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        }

        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .btn-primary {
            background: linear-gradient(45deg, #1e3c72, #2a5298);
            border: none;
            border-radius: 10px;
            transition: transform 0.2s ease, background 0.3s ease;
        }

        .btn-primary:hover {
            transform: scale(1.05);
            background: linear-gradient(45deg, #2a5298, #1e3c72);
        }

        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }

        .alert {
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .status-activo {
            color: #28a745;
            font-weight: bold;
        }

        .status-inactivo {
            color: #dc3545;
            font-weight: bold;
        }

        .status-pendiente {
            color: #ffc107;
            font-weight: bold;
        }

        .status-confirmada {
            color: #17a2b8;
            font-weight: bold;
        }

        .status-realizada {
            color: #28a745;
            font-weight: bold;
        }

        .status-cancelada {
            color: #dc3545;
            font-weight: bold;
        }

        .pagination {
            justify-content: center;
            margin-top: 20px;
        }

        .filters {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .badge-especialidad {
            background-color: #e9ecef;
            color: #495057;
            padding: 0.25rem 0.5rem;
            margin: 0.125rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 sidebar">
                <div class="p-3">
                    <div class="text-center mb-4">
                        <i class="fas fa-user-shield fa-3x text-primary mb-2"></i>
                        <h5 id="nombreAdmin">Administrador</h5>
                        <small class="text-muted">Admin</small>
                    </div>
                    <nav class="nav flex-column">
                        <a class="nav-link active" href="#" data-section="dashboard">
                            <i class="fas fa-tachometer-alt me-2"></i>Panel Principal
                        </a>
                        <a class="nav-link" href="#" data-section="usuarios">
                            <i class="fas fa-users me-2"></i>Usuarios
                        </a>
                        <a class="nav-link" href="#" data-section="medicos">
                            <i class="fas fa-user-md me-2"></i>Médicos
                        </a>
                        <a class="nav-link" href="#" data-section="citas">
                            <i class="fas fa-calendar-check me-2"></i>Citas
                        </a>
                        <a class="nav-link" href="#" data-section="reportes">
                            <i class="fas fa-chart-line me-2"></i>Reportes
                        </a>
                        <hr>
                        <a class="nav-link text-danger" href="#" onclick="cerrarSesion()">
                            <i class="fas fa-sign-out-alt me-2"></i>Cerrar Sesión
                        </a>
                    </nav>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10">
                <div class="main-content">
                    <!-- Dashboard Section -->
                    <div id="dashboard" class="content-section">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2><i class="fas fa-tachometer-alt text-primary me-2"></i>Panel Principal</h2>
                            <span class="badge bg-primary p-2" id="fechaActual"></span>
                        </div>
                        <div class="loading" id="dashboardLoading">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p>Cargando estadísticas...</p>
                        </div>
                        <div class="row mb-4" id="dashboardStats" style="display: none;">
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <i class="fas fa-users fa-2x text-primary mb-2"></i>
                                        <h3 class="text-primary" id="totalPacientes">0</h3>
                                        <small class="text-muted">Pacientes</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <i class="fas fa-calendar-clock fa-2x text-warning mb-2"></i>
                                        <h3 class="text-warning" id="citasPendientes">0</h3>
                                        <small class="text-muted">Citas Pendientes</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <i class="fas fa-calendar-check fa-2x text-success mb-2"></i>
                                        <h3 class="text-success" id="citasHoy">0</h3>
                                        <small class="text-muted">Citas Hoy</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <i class="fas fa-times-circle fa-2x text-danger mb-2"></i>
                                        <h3 class="text-danger" id="citasCanceladas">0</h3>
                                        <small class="text-muted">Citas Canceladas</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Usuarios Section -->
                    <div id="usuarios" class="content-section" style="display:none;">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2><i class="fas fa-users text-primary me-2"></i>Gestión de Usuarios</h2>
                        </div>

                        <!-- Filtros -->
                        <div class="filters">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <select class="form-select" id="filtroTipoUsuario">
                                        <option value="todos">Todos los roles</option>
                                        <option value="paciente">Pacientes</option>
                                        <option value="medico">Médicos</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <select class="form-select" id="filtroEstadoUsuario">
                                        <option value="todos">Todos los estados</option>
                                        <option value="activo">Activos</option>
                                        <option value="inactivo">Inactivos</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-primary" onclick="cargarUsuarios()">
                                        <i class="fas fa-search"></i> Filtrar
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="loading" id="usuariosLoading">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p>Cargando usuarios...</p>
                        </div>

                        <div id="usuariosContainer" class="fade-in">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Nombre</th>
                                            <th>Correo</th>
                                            <th>Documento</th>
                                            <th>Teléfono</th>
                                            <th>Rol</th>
                                            <th>Estado</th>
                                            <th>Fecha Registro</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tablaUsuarios">
                                        <!-- Usuarios se cargan dinámicamente -->
                                    </tbody>
                                </table>
                            </div>
                            <nav id="paginacionUsuarios"></nav>
                        </div>
                    </div>

                    <!-- Médicos Section -->
                    <div id="medicos" class="content-section" style="display:none;">
                        <h2><i class="fas fa-user-md text-primary me-2"></i>Gestión de Médicos</h2>

                        <!-- Crear Especialidad -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5><i class="fas fa-stethoscope me-2"></i>Crear Especialidad</h5>
                            </div>
                            <div class="card-body">
                                <form id="formCrearEspecialidad" onsubmit="crearEspecialidad(event)">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <input type="text" class="form-control" id="nuevaEspecialidad"
                                                placeholder="Nombre de la especialidad" required>
                                        </div>
                                        <div class="col-md-6">
                                            <textarea class="form-control" id="descripcionEspecialidad"
                                                placeholder="Descripción (opcional)" rows="1"></textarea>
                                        </div>
                                        <div class="col-md-12">
                                            <button class="btn btn-primary" type="submit">
                                                <i class="fas fa-plus"></i> Agregar Especialidad
                                            </button>
                                        </div>
                                    </div>
                                </form>
                                <div class="mt-3">
                                    <strong>Especialidades disponibles:</strong>
                                    <div id="listaEspecialidades" class="mt-2">
                                        <!-- Se cargan dinámicamente -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Crear Médico -->
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-user-plus me-2"></i>Crear Médico</h5>
                            </div>
                            <div class="card-body">
                                <form id="formCrearMedico" onsubmit="crearMedico(event)">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Nombre completo *</label>
                                            <input type="text" id="medicoNombre" class="form-control" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Correo</label>
                                            <input type="email" id="medicoCorreo" class="form-control">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Registro profesional *</label>
                                            <input type="text" id="medicoRegistro" class="form-control" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Teléfono</label>
                                            <input type="text" id="medicoTelefono" class="form-control">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Consultorio</label>
                                            <input type="text" id="medicoConsultorio" class="form-control">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Años de experiencia</label>
                                            <input type="number" id="medicoExp" class="form-control" min="0">
                                        </div>
                                        <div class="col-md-12">
                                            <label class="form-label">Especialidades *</label>
                                            <select id="medicoEspecialidades" class="form-select" multiple required>
                                                <!-- Se cargan dinámicamente -->
                                            </select>
                                            <small class="text-muted">Mantén Ctrl presionado para seleccionar múltiples
                                                especialidades</small>
                                        </div>
                                        <div class="col-md-12">
                                            <label class="form-label">Biografía</label>
                                            <textarea id="medicoBio" class="form-control" rows="3"></textarea>
                                        </div>
                                        <div class="col-md-12">
                                            <label class="form-label">URL de foto</label>
                                            <input type="url" id="medicoFoto" class="form-control">
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <button class="btn btn-primary" type="submit">
                                            <i class="fas fa-save"></i> Crear Médico
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Citas Section -->
                    <div id="citas" class="content-section" style="display:none;">
                        <h2><i class="fas fa-calendar-check text-primary me-2"></i>Gestión de Citas</h2>

                        <!-- Filtros de citas -->
                        <div class="filters">
                            <div class="row g-3">
                                <div class="col-md-2">
                                    <select class="form-select" id="filtroEstadoCita">
                                        <option value="todos">Todos los estados</option>
                                        <option value="Pendiente">Pendientes</option>
                                        <option value="Confirmada">Confirmadas</option>
                                        <option value="Realizada">Realizadas</option>
                                        <option value="Cancelada">Canceladas</option>
                                        <option value="No asistió">No asistió</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <input type="date" class="form-control" id="fechaInicioCitas">
                                </div>
                                <div class="col-md-2">
                                    <input type="date" class="form-control" id="fechaFinCitas">
                                </div>
                                <div class="col-md-2">
                                    <input type="text" class="form-control" id="filtroMedicoCita" placeholder="Médico">
                                </div>
                                <div class="col-md-2">
                                    <input type="text" class="form-control" id="filtroPacienteCita"
                                        placeholder="Paciente">
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-primary w-100" onclick="cargarCitas()">
                                        <i class="fas fa-search"></i> Filtrar
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="loading" id="citasLoading">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p>Cargando citas...</p>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Paciente</th>
                                        <th>Médico</th>
                                        <th>Fecha</th>
                                        <th>Hora</th>
                                        <th>Especialidad</th>
                                        <th>Motivo</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaCitas">
                                    <!-- Citas se cargan dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                        <nav id="paginacionCitas"></nav>
                    </div>

                    <!-- Reportes Section -->
                    <div id="reportes" class="content-section" style="display:none;">
                        <h2><i class="fas fa-chart-line text-primary me-2"></i>Reportes</h2>

                        <div class="row mb-4">
                            <div class="col-md-4">
                                <select class="form-select" id="tipoReporte">
                                    <option value="citas_especialidad">Citas por Especialidad</option>
                                    <option value="no_asistencia">Tasa de No Asistencia</option>
                                    <option value="citas_mensuales">Citas Mensuales</option>
                                    <option value="estados_citas">Estados de Citas</option>
                                    <option value="eficiencia_medicos">Eficiencia Médicos</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <input type="date" class="form-control" id="fechaInicioReporte">
                            </div>
                            <div class="col-md-3">
                                <input type="date" class="form-control" id="fechaFinReporte">
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-primary w-100" onclick="generarReporte()">
                                    <i class="fas fa-chart-bar"></i> Generar
                                </button>
                            </div>
                        </div>

                        <div class="loading" id="reportesLoading">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p>Generando reporte...</p>
                        </div>

                        <div id="reporteContainer">
                            <!-- El reporte se carga aquí dinámicamente -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para cancelar cita -->
    <div class="modal fade" id="modalCancelarCita" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Cancelar Cita</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Motivo de cancelación:</label>
                        <textarea class="form-control" id="motivoCancelacion" rows="3"
                            placeholder="Ingrese el motivo de la cancelación..." required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-danger" onclick="confirmarCancelacion()">Cancelar Cita</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para cambiar estado de cita -->
    <div class="modal fade" id="modalCambiarEstado" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Cambiar Estado de Cita</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Nuevo estado:</label>
                        <select class="form-select" id="nuevoEstadoCita">
                            <option value="realizada">Realizada</option>
                            <option value="no_asistio">No asistió</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notas (opcional):</label>
                        <textarea class="form-control" id="notasEstado" rows="3"
                            placeholder="Ingrese notas adicionales..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" onclick="confirmarCambioEstado()">Actualizar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        // Configuración de la API
        const API_BASE_URL = 'http://localhost:3000';
        let currentUser = null;
        let citaACancelar = null;
        let citaCambiarEstado = null;

        // Función para obtener token
        function getToken() {
            return localStorage.getItem('token');
        }

        // Headers para las peticiones
        function getHeaders() {
            const token = getToken();
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };
        }

        // Verificar autenticación
        function verificarAuth() {
            const token = getToken();
            if (!token) {
                window.location.href = '../Acceso.html';
                return false;
            }

            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                if (payload.exp * 1000 < Date.now()) {
                    localStorage.removeItem('token');
                    window.location.href = '../Acceso.html';
                    return false;
                }

                currentUser = payload;
                console.log('Usuario autenticado:', currentUser);

                // Mostrar nombre del usuario
                if (currentUser.nombre_completo) {
                    document.getElementById('nombreAdmin').textContent = currentUser.nombre_completo;
                }

                return true;
            } catch (error) {
                console.error('Error verificando token:', error);
                localStorage.removeItem('token');
                window.location.href = '../Acceso.html';
                return false;
            }
        }

        // Inicialización
        document.addEventListener('DOMContentLoaded', function () {
            if (!verificarAuth()) {
                return;
            }
            inicializarPanel();
        });

        function inicializarPanel() {
            document.getElementById('fechaActual').innerText = new Date().toLocaleDateString('es-ES');
            cargarDashboard();
            cargarEspecialidades();
            configurarNavegacion();
        }

        // Navegación entre secciones
        function configurarNavegacion() {
            const links = document.querySelectorAll('.nav-link[data-section]');
            const sections = document.querySelectorAll('.content-section');

            links.forEach(link => {
                link.addEventListener('click', async e => {
                    e.preventDefault();
                    const target = link.dataset.section;

                    // Ocultar todas las secciones
                    sections.forEach(sec => sec.style.display = 'none');

                    // Mostrar la sección seleccionada
                    const targetSection = document.getElementById(target);
                    if (targetSection) {
                        targetSection.style.display = 'block';
                    }

                    // Actualizar navegación activa
                    links.forEach(l => l.classList.remove('active'));
                    link.classList.add('active');

                    // Cargar datos según la sección
                    try {
                        switch (target) {
                            case 'usuarios':
                                await cargarUsuarios();
                                break;
                            case 'citas':
                                await cargarCitas();
                                break;
                            case 'dashboard':
                                await cargarDashboard();
                                break;
                        }
                    } catch (error) {
                        console.error(`Error al cargar sección ${target}:`, error);
                        mostrarAlerta(`Error al cargar la sección ${target}: ${error.message}`, 'danger');
                    }
                });
            });
        }

        // Dashboard
        async function cargarDashboard() {
            const loading = document.getElementById('dashboardLoading');
            const stats = document.getElementById('dashboardStats');

            loading.style.display = 'block';
            stats.style.display = 'none';

            try {
                const response = await fetch(`${API_BASE_URL}/admin/dashboard`, {
                    headers: getHeaders()
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    const estadisticas = data.data.stats;
                    document.getElementById('totalPacientes').textContent = estadisticas.total_pacientes || 0;
                    document.getElementById('citasPendientes').textContent = estadisticas.citas_pendientes || 0;
                    document.getElementById('citasHoy').textContent = estadisticas.citas_hoy || 0;
                    document.getElementById('citasCanceladas').textContent = estadisticas.citas_canceladas || 0;
                } else {
                    throw new Error(data.message || 'Error en la respuesta');
                }
            } catch (error) {
                console.error('Error al cargar dashboard:', error);
                mostrarAlerta('Error al cargar las estadísticas: ' + error.message, 'danger');
            } finally {
                loading.style.display = 'none';
                stats.style.display = 'flex';
            }
        }

        // Usuarios
        async function cargarUsuarios(page = 1) {
            const loading = document.getElementById('usuariosLoading');

            if (loading) loading.style.display = 'block';

            try {
                const tipo = document.getElementById('filtroTipoUsuario')?.value || 'todos';
                const estado = document.getElementById('filtroEstadoUsuario')?.value || 'todos';

                const params = new URLSearchParams({
                    page: page.toString(),
                    limit: '10',
                    tipo,
                    estado
                });

                const response = await fetch(`${API_BASE_URL}/admin/usuarios?${params}`, {
                    headers: getHeaders()
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    renderizarUsuarios(data.data.users);
                    renderizarPaginacion(data.data.pagination, 'paginacionUsuarios', cargarUsuarios);
                } else {
                    throw new Error(data.message || 'Error en la respuesta');
                }
            } catch (error) {
                console.error('Error al cargar usuarios:', error);
                mostrarAlerta('Error al cargar usuarios: ' + error.message, 'danger');

                const tbody = document.getElementById('tablaUsuarios');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error al cargar usuarios</td></tr>';
                }
            } finally {
                if (loading) loading.style.display = 'none';
            }
        }

        function renderizarUsuarios(usuarios) {
            const tbody = document.getElementById('tablaUsuarios');
            tbody.innerHTML = '';

            if (!usuarios || usuarios.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">No se encontraron usuarios</td></tr>';
                return;
            }

            usuarios.forEach(usuario => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${usuario.nombre_completo || 'N/A'}</td>
                    <td>${usuario.correo}</td>
                    <td>${usuario.documento || 'N/A'}</td>
                    <td>${usuario.telefono || 'N/A'}</td>
                    <td><span class="badge bg-info">${usuario.rol}</span></td>
                    <td><span class="status-${usuario.activo ? 'activo' : 'inactivo'}">${usuario.activo ? 'Activo' : 'Inactivo'}</span></td>
                    <td>${new Date(usuario.created_at).toLocaleDateString('es-ES')}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-${usuario.activo ? 'warning' : 'success'}" 
                                    onclick="toggleUsuario(${usuario.id_usuario}, ${!usuario.activo})">
                                ${usuario.activo ? 'Desactivar' : 'Activar'}
                            </button>
                            
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function toggleUsuario(id, activar) {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/usuarios/${id}/estado`, {
                    method: 'PUT',
                    headers: getHeaders(),
                    body: JSON.stringify({ activo: activar })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    mostrarAlerta(data.message, 'success');
                    cargarUsuarios();
                } else {
                    throw new Error(data.message || 'Error en la respuesta');
                }
            } catch (error) {
                console.error('Error al cambiar estado:', error);
                mostrarAlerta('Error al cambiar estado del usuario: ' + error.message, 'danger');
            }
        }

        async function eliminarUsuario(id) {
            if (!confirm('¿Estás seguro de eliminar este usuario? Esta acción no se puede deshacer.')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/admin/users/${id}`, {
                    method: 'DELETE',
                    headers: getHeaders()
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    mostrarAlerta(data.message, 'success');
                    cargarUsuarios();
                } else {
                    throw new Error(data.message || 'Error en la respuesta');
                }
            } catch (error) {
                console.error('Error al eliminar usuario:', error);
                mostrarAlerta('Error al eliminar usuario: ' + error.message, 'danger');
            }
        }

        // Especialidades
        async function cargarEspecialidades() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/especialidades`, {
                    headers: getHeaders()
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    renderizarEspecialidades(data.data);
                } else {
                    throw new Error(data.message || 'Error en la respuesta');
                }
            } catch (error) {
                console.error('Error al cargar especialidades:', error);
                mostrarAlerta('Error al cargar especialidades: ' + error.message, 'danger');
            }
        }

        function renderizarEspecialidades(especialidades) {
            const lista = document.getElementById('listaEspecialidades');
            const select = document.getElementById('medicoEspecialidades');

            lista.innerHTML = '';
            select.innerHTML = '';

            if (!especialidades || especialidades.length === 0) {
                lista.innerHTML = '<span class="text-muted">No hay especialidades disponibles</span>';
                return;
            }

            especialidades.forEach(esp => {
                // Lista visual
                const badge = document.createElement('span');
                badge.className = 'badge-especialidad me-2 mb-2 d-inline-block';
                badge.innerHTML = `
                    ${esp.nombre}
                    ${esp.descripcion ? `<small class="d-block text-muted">${esp.descripcion}</small>` : ''}
                `;
                lista.appendChild(badge);

                // Select para el formulario
                const option = document.createElement('option');
                option.value = esp.id_especialidad;
                option.textContent = esp.nombre;
                select.appendChild(option);
            });
        }

        async function crearEspecialidad(event) {
            event.preventDefault();

            const nombre = document.getElementById('nuevaEspecialidad').value.trim();
            const descripcion = document.getElementById('descripcionEspecialidad').value.trim();

            if (!nombre) {
                mostrarAlerta("El nombre de la especialidad es obligatorio", "warning");
                return;
            }

            if (!confirm("¿Está seguro que quiere registrar la especialidad?")) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/admin/especialidades`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        nombre,
                        descripcion: descripcion || null
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    mostrarAlerta(data.message || `Error HTTP ${response.status}`, "danger");
                    return;
                }

                if (data.success) {
                    mostrarAlerta(data.message, "success");
                    document.getElementById('nuevaEspecialidad').value = '';
                    document.getElementById('descripcionEspecialidad').value = '';
                    cargarEspecialidades();
                } else {
                    mostrarAlerta(data.message || "Error en la respuesta", "danger");
                }
            } catch (error) {
                console.error("Error al crear especialidad:", error);
                mostrarAlerta("Error al crear especialidad: " + error.message, "danger");
            }
        }

        // Médicos
        async function crearMedico(event) {
            event.preventDefault();

            const especialidadesSelect = document.getElementById('medicoEspecialidades');
            const especialidades = Array.from(especialidadesSelect.selectedOptions).map(opt => parseInt(opt.value));

            if (especialidades.length === 0) {
                mostrarAlerta('Seleccione al menos una especialidad', 'warning');
                return;
            }

            const medicoData = {
                nombre_completo: document.getElementById('medicoNombre').value.trim(),
                correo: document.getElementById('medicoCorreo').value.trim() || null,
                registro_profesional: document.getElementById('medicoRegistro').value.trim(),
                consultorio: document.getElementById('medicoConsultorio').value.trim() || null,
                telefono: document.getElementById('medicoTelefono').value.trim() || null,
                biografia: document.getElementById('medicoBio').value.trim() || null,
                experiencia_anos: parseInt(document.getElementById('medicoExp').value) || null,
                foto_url: document.getElementById('medicoFoto').value.trim() || null,
                especialidades
            };

            if (!confirm("¿Está seguro que quiere registrar al doctor?")) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/admin/medicos`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify(medicoData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    mostrarAlerta(data.message, 'success');
                    document.getElementById('formCrearMedico').reset();
                } else {
                    mostrarAlerta(data.message || 'Error al crear médico', 'danger');
                }
            } catch (error) {
                console.error('Error al crear médico:', error);
                mostrarAlerta('Error al crear médico: ' + error.message, 'danger');
            }
        }

        // Citas
        async function cargarCitas(page = 1) {
            const loading = document.getElementById('citasLoading');

            if (loading) loading.style.display = 'block';

            try {
                const estado = document.getElementById('filtroEstadoCita')?.value || 'todos';
                const fechaInicio = document.getElementById('fechaInicioCitas')?.value || '';
                const fechaFin = document.getElementById('fechaFinCitas')?.value || '';
                const medico = document.getElementById('filtroMedicoCita')?.value || '';
                const paciente = document.getElementById('filtroPacienteCita')?.value || '';

                const params = new URLSearchParams({
                    page: page.toString(),
                    limit: '10'
                });

                if (estado && estado !== 'todos') params.append('estado', estado);
                if (fechaInicio) params.append('fecha_inicio', fechaInicio);
                if (fechaFin) params.append('fecha_fin', fechaFin);
                if (medico.trim()) params.append('medico', medico);
                if (paciente.trim()) params.append('paciente', paciente);

                const response = await fetch(`${API_BASE_URL}/admin/citas?${params}`, {
                    headers: getHeaders()
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    renderizarCitas(data.data.citas);
                    renderizarPaginacion(data.data.pagination, 'paginacionCitas', cargarCitas);
                } else {
                    throw new Error(data.message || 'Error en la respuesta');
                }
            } catch (error) {
                console.error('Error al cargar citas:', error);
                mostrarAlerta('Error al cargar citas: ' + error.message, 'danger');
            } finally {
                if (loading) loading.style.display = 'none';
            }
        }

        function renderizarCitas(citas) {
                const tabla = document.getElementById("tablaCitas");
                tabla.innerHTML = "";

                citas.forEach((cita) => {
                    const fila = document.createElement("tr");

                    fila.innerHTML = `
      <td>${cita.paciente}</td>
      <td>${cita.medico}</td>
      <td>${cita.fecha}</td>
      <td>${cita.hora}</td>
      <td>${cita.especialidad}</td>
      <td>${cita.motivo}</td>
      <td>
        <span class="badge bg-${cita.estado === "pendiente" || cita.estado === "Pendiente"
                            ? "warning"
                            : cita.estado === "confirmada" || cita.estado === "Confirmada"
                                ? "success"
                                : cita.estado === "realizada" || cita.estado === "Realizada"
                                    ? "info"
                                    : cita.estado === "cancelada" || cita.estado === "Cancelada"
                                        ? "danger"
                                        : cita.estado === "no_asistio" || cita.estado === "No asistió"
                                            ? "dark"
                                            : "secondary"
                        }">
          ${cita.estado}
        </span>
      </td>
      <td>
        <div class="dropdown">
          <button class="btn btn-sm btn-outline-primary dropdown-toggle" 
                  type="button" data-bs-toggle="dropdown">
            Acciones
          </button>
          <ul class="dropdown-menu">
            ${(cita.estado === "pendiente" || cita.estado === "Pendiente")
                            ? `
                  <li><a class="dropdown-item" href="#" onclick="cambiarEstadoCita(${cita.id_cita}, 'confirmada')">Confirmar</a></li>
                  <li><a class="dropdown-item text-danger" href="#" onclick="cancelarCita(${cita.id_cita})">Cancelar</a></li>
                `
                            : (cita.estado === "confirmada" || cita.estado === "Confirmada")
                                ? `
                  <li><a class="dropdown-item text-success" href="#" onclick="cambiarEstadoCita(${cita.id_cita}, 'realizada')">Marcar como Realizada</a></li>
                  <li><a class="dropdown-item text-warning" href="#" onclick="cambiarEstadoCita(${cita.id_cita}, 'no_asistio')">Marcar como No Asistió</a></li>
                  <li><a class="dropdown-item text-danger" href="#" onclick="cancelarCita(${cita.id_cita})">Cancelar</a></li>
                  <li><a class="dropdown-item text-secondary" href="#" onclick="reprogramarCita(${cita.id_cita})">Reprogramar</a></li>
                `
                                : (cita.estado === "realizada" || cita.estado === "Realizada")
                                    ? `
                  <li><a class="dropdown-item disabled" href="#">Cita Completada</a></li>
                `
                                    : (cita.estado === "cancelada" || cita.estado === "Cancelada")
                                        ? `
                  <li><a class="dropdown-item text-secondary" href="#" onclick="reprogramarCita(${cita.id_cita})">Reprogramar</a></li>
                `
                                        : (cita.estado === "no_asistio" || cita.estado === "No asistió")
                                            ? `
                  <li><a class="dropdown-item text-secondary" href="#" onclick="reprogramarCita(${cita.id_cita})">Reprogramar</a></li>
                `
                                            : `
                  <li><a class="dropdown-item disabled" href="#">Sin acciones</a></li>
                `
                        }
          </ul>
        </div>
      </td>
    `;

                    tabla.appendChild(fila);
                });
            }

            // Función auxiliar para cambiar estado de cita
            function cambiarEstadoCita(idCita, nuevoEstado) {
                // Mostrar modal de confirmación con notas si es necesario
                citaCambiarEstado = idCita;
                document.getElementById('nuevoEstadoCita').value = nuevoEstado;

                // Personalizar el modal según el estado
                const modalTitle = document.querySelector('#modalCambiarEstado .modal-title');
                if (nuevoEstado === 'confirmada') {
                    modalTitle.textContent = 'Confirmar Cita';
                } else if (nuevoEstado === 'realizada') {
                    modalTitle.textContent = 'Marcar como Realizada';
                } else if (nuevoEstado === 'no_asistio') {
                    modalTitle.textContent = 'Marcar como No Asistió';
                }

                const modal = new bootstrap.Modal(document.getElementById('modalCambiarEstado'));
                modal.show();
            }

            // Función auxiliar para cancelar cita
            function cancelarCita(idCita) {
                if (confirm('¿Está seguro de que desea cancelar esta cita?')) {
                    citaCambiarEstado = idCita;
                    document.getElementById('nuevoEstadoCita').value = 'cancelada';
                    document.querySelector('#modalCambiarEstado .modal-title').textContent = 'Cancelar Cita';

                    const modal = new bootstrap.Modal(document.getElementById('modalCambiarEstado'));
                    modal.show();
                }
            }

            // Función auxiliar para reprogramar cita (placeholder)
            function reprogramarCita(idCita) {
                // Aquí puedes implementar la lógica de reprogramación
                alert('Funcionalidad de reprogramación en desarrollo. ID: ' + idCita);
            }

            // Función actualizada para confirmar cambio de estado
          async function confirmarCambioEstado() {
                const estado = document.getElementById('nuevoEstadoCita').value;
                const notas = document.getElementById('notasEstado').value.trim();

                try {
                    let endpoint = '';
                    let method = 'PUT';
                    let body = {};

                    // Determinar el endpoint según el estado
                    if (estado === 'cancelada') {
                        endpoint = `${API_BASE_URL}/admin/citas/${citaCambiarEstado}/cancel`;
                        body = {
                            motivo: notas || 'Cancelada desde panel administrativo',
                            cancelada_por: 'admin'
                        };
                    } else {
                        endpoint = `${API_BASE_URL}/admin/citas/${citaCambiarEstado}/status`;
                        body = {
                            estado: estado.toLowerCase(),  // 👈 siempre en minúsculas
                            notas: notas
                        };
                    }

                    // 👇 fetch siempre aquí, no dentro del if/else
                    const response = await fetch(endpoint, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                            ...getHeaders()
                        },
                        body: JSON.stringify(body)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }

                    const data = await response.json();

                    if (data.success) {
                        mostrarAlerta(data.message, 'success');
                        cargarCitas();

                        const modal = bootstrap.Modal.getInstance(document.getElementById('modalCambiarEstado'));
                        modal.hide();
                    } else {
                        throw new Error(data.message || 'Error al actualizar estado');
                    }
                } catch (error) {
                    console.error('Error al actualizar estado:', error);
                    mostrarAlerta('Error al actualizar estado: ' + error.message, 'danger');
                }
            }


        // Reportes
        async function generarReporte() {
            const loading = document.getElementById('reportesLoading');
            const container = document.getElementById('reporteContainer');

            loading.style.display = 'block';
            container.innerHTML = '';

            const tipo = document.getElementById('tipoReporte').value;
            const fechaInicio = document.getElementById('fechaInicioReporte').value;
            const fechaFin = document.getElementById('fechaFinReporte').value;

            try {
                const params = new URLSearchParams({ tipo });

                if (fechaInicio) params.append('fecha_inicio', fechaInicio);
                if (fechaFin) params.append('fecha_fin', fechaFin);

                const response = await fetch(`${API_BASE_URL}/admin/reportes?${params}`, {
                    headers: getHeaders()
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    renderizarReporte(data.data, tipo);
                } else {
                    throw new Error(data.message || 'Error en la respuesta');
                }
            } catch (error) {
                console.error('Error al generar reporte:', error);
                mostrarAlerta('Error al generar reporte: ' + error.message, 'danger');
            } finally {
                loading.style.display = 'none';
            }
        }

        function renderizarReporte(datos, tipo) {
            const container = document.getElementById('reporteContainer');

            if (!datos || datos.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No hay datos disponibles para el reporte seleccionado.</div>';
                return;
            }

            let html = '<div class="card"><div class="card-body"><div class="table-responsive"><table class="table table-striped">';

            switch (tipo) {
                case 'citas_especialidad':
                    html += `
                        <thead class="table-dark">
                            <tr>
                                <th>Especialidad</th>
                                <th>Total Citas</th>
                                <th>Realizadas</th>
                                <th>Canceladas</th>
                                <th>No Asistió</th>
                            </tr>
                        </thead>
                        <tbody>
                    `;
                    datos.forEach(item => {
                        html += `
                            <tr>
                                <td>${item.especialidad || 'Sin especialidad'}</td>
                                <td>${item.total_citas || 0}</td>
                                <td class="text-success">${item.realizadas || 0}</td>
                                <td class="text-danger">${item.canceladas || 0}</td>
                                <td class="text-warning">${item.no_asistio || 0}</td>
                            </tr>
                        `;
                    });
                    break;

                case 'no_asistencia':
                    html += `
                        <thead class="table-dark">
                            <tr>
                                <th>Médico</th>
                                <th>Total Citas</th>
                                <th>No Asistió</th>
                                <th>Tasa No Asistencia (%)</th>
                            </tr>
                        </thead>
                        <tbody>
                    `;
                    datos.forEach(item => {
                        html += `
                            <tr>
                                <td>${item.medico || 'N/A'}</td>
                                <td>${item.total_citas || 0}</td>
                                <td class="text-warning">${item.no_asistio || 0}</td>
                                <td class="text-danger">${parseFloat(item.tasa_no_asistencia || 0).toFixed(2)}%</td>
                            </tr>
                        `;
                    });
                    break;

                case 'citas_mensuales':
                    html += `
                        <thead class="table-dark">
                            <tr>
                                <th>Mes</th>
                                <th>Total Citas</th>
                                <th>Realizadas</th>
                                <th>Canceladas</th>
                                <th>No Asistió</th>
                                <th>Pendientes</th>
                            </tr>
                        </thead>
                        <tbody>
                    `;
                    datos.forEach(item => {
                        const fechaMes = item.mes ? new Date(item.mes + '-01').toLocaleDateString('es-ES', { year: 'numeric', month: 'long' }) : 'N/A';
                        html += `
                            <tr>
                                <td>${fechaMes}</td>
                                <td>${item.total_citas || 0}</td>
                                <td class="text-success">${item.realizadas || 0}</td>
                                <td class="text-danger">${item.canceladas || 0}</td>
                                <td class="text-warning">${item.no_asistio || 0}</td>
                                <td class="text-info">${item.pendientes || 0}</td>
                            </tr>
                        `;
                    });
                    break;

                case 'estados_citas':
                    html += `
                        <thead class="table-dark">
                            <tr>
                                <th>Estado</th>
                                <th>Total Citas</th>
                                <th>Porcentaje</th>
                            </tr>
                        </thead>
                        <tbody>
                    `;
                    datos.forEach(item => {
                        html += `
                            <tr>
                                <td>
                                    <span class="badge" style="background-color: ${item.color}; color: white;">
                                        ${item.estado}
                                    </span>
                                </td>
                                <td>${item.total_citas || 0}</td>
                                <td>${parseFloat(item.porcentaje || 0).toFixed(2)}%</td>
                            </tr>
                        `;
                    });
                    break;

                case 'eficiencia_medicos':
                    html += `
                        <thead class="table-dark">
                            <tr>
                                <th>Médico</th>
                                <th>Total Citas</th>
                                <th>Realizadas</th>
                                <th>Canceladas</th>
                                <th>No Asistió</th>
                                <th>Tasa Éxito (%)</th>
                                <th>Tiempo Promedio (min)</th>
                            </tr>
                        </thead>
                        <tbody>
                    `;
                    datos.forEach(item => {
                        html += `
                            <tr>
                                <td>${item.medico || 'N/A'}</td>
                                <td>${item.total_citas || 0}</td>
                                <td class="text-success">${item.realizadas || 0}</td>
                                <td class="text-danger">${item.canceladas || 0}</td>
                                <td class="text-warning">${item.no_asistio || 0}</td>
                                <td class="text-primary">${parseFloat(item.tasa_exito || 0).toFixed(2)}%</td>
                                <td>${parseFloat(item.tiempo_promedio_consulta || 0).toFixed(0)} min</td>
                            </tr>
                        `;
                    });
                    break;

                default:
                    html += `
                        <tbody>
                            <tr><td colspan="100%" class="text-center">Tipo de reporte no reconocido</td></tr>
                        </tbody>
                    `;
            }

            html += '</tbody></table></div></div></div>';
            container.innerHTML = html;
        }

        // Paginación
        function renderizarPaginacion(pagination, containerId, callback) {
            const container = document.getElementById(containerId);
            if (!container || !pagination || pagination.pages <= 1) {
                if (container) container.innerHTML = '';
                return;
            }

            let html = '<ul class="pagination">';

            html += `
                <li class="page-item ${pagination.page === 1 ? 'disabled' : ''}">
                    <button class="page-link" onclick="${callback.name}(${pagination.page - 1})" ${pagination.page === 1 ? 'disabled' : ''}>
                        Anterior
                    </button>
                </li>
            `;

            const maxPagesToShow = 5;
            const startPage = Math.max(1, pagination.page - Math.floor(maxPagesToShow / 2));
            const endPage = Math.min(pagination.pages, startPage + maxPagesToShow - 1);

            if (startPage > 1) {
                html += `<li class="page-item"><button class="page-link" onclick="${callback.name}(1)">1</button></li>`;
                if (startPage > 2) html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
            }

            for (let i = startPage; i <= endPage; i++) {
                html += `
                    <li class="page-item ${i === pagination.page ? 'active' : ''}">
                        <button class="page-link" onclick="${callback.name}(${i})">${i}</button>
                    </li>
                `;
            }

            if (endPage < pagination.pages) {
                if (endPage < pagination.pages - 1) html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                html += `<li class="page-item"><button class="page-link" onclick="${callback.name}(${pagination.pages})">${pagination.pages}</button></li>`;
            }

            html += `
                <li class="page-item ${pagination.page === pagination.pages ? 'disabled' : ''}">
                    <button class="page-link" onclick="${callback.name}(${pagination.page + 1})" ${pagination.page === pagination.pages ? 'disabled' : ''}>
                        Siguiente
                    </button>
                </li>
            `;

            html += '</ul>';
            container.innerHTML = html;
        }

        // Utilidades
        function mostrarAlerta(mensaje, tipo = 'info') {
            document.querySelectorAll('.alert').forEach(alert => {
                if (alert.classList.contains('alert-dismissible')) {
                    alert.remove();
                }
            });

            const alertContainer = document.createElement('div');
            alertContainer.className = `alert alert-${tipo} alert-dismissible fade show`;
            alertContainer.innerHTML = `
                ${mensaje}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            const mainContent = document.querySelector('.main-content');
            mainContent.insertBefore(alertContainer, mainContent.firstChild);

            setTimeout(() => {
                if (alertContainer.parentNode) {
                    alertContainer.remove();
                }
            }, 5000);
        }

        function cerrarSesion() {
            if (confirm('¿Estás seguro de cerrar sesión?')) {
                localStorage.removeItem('token');
                window.location.href = '../Acceso.html';
            }
        }

        setInterval(() => {
            const dashboardSection = document.getElementById('dashboard');
            if (dashboardSection && dashboardSection.style.display !== 'none') {
                cargarDashboard();
            }
        }, 300000);

        window.addEventListener('online', function () {
            mostrarAlerta('Conexión restaurada', 'success');
            cargarDashboard();
        });

        window.addEventListener('offline', function () {
            mostrarAlerta('Conexión perdida. Algunas funciones pueden no estar disponibles.', 'warning');
        });
    </script>
</body>

</html>