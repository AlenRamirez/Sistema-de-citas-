<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administrador - Sistema de Citas Médicas</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }

        .sidebar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            min-height: 100vh;
            box-shadow: 2px 0 20px rgba(0, 0, 0, 0.1);
        }

        .nav-link {
            color: #333 !important;
            border-radius: 10px;
            margin: 5px 0;
            transition: all 0.3s ease;
        }

        .nav-link:hover,
        .nav-link.active {
            background: linear-gradient(45deg, #1e3c72, #2a5298);
            color: white !important;
            transform: translateX(5px);
        }

        .main-content {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            margin: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        }

        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .btn-primary {
            background: linear-gradient(45deg, #1e3c72, #2a5298);
            border: none;
            border-radius: 10px;
            transition: transform 0.2s ease, background 0.3s ease;
        }

        .btn-primary:hover {
            transform: scale(1.05);
            background: linear-gradient(45deg, #2a5298, #1e3c72);
        }

        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }

        .alert {
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .status-activo {
            color: #28a745;
            font-weight: bold;
        }

        .status-inactivo {
            color: #dc3545;
            font-weight: bold;
        }

        .status-pendiente {
            color: #ffc107;
            font-weight: bold;
        }

        .status-confirmada {
            color: #17a2b8;
            font-weight: bold;
        }

        .status-realizada {
            color: #28a745;
            font-weight: bold;
        }

        .status-cancelada {
            color: #dc3545;
            font-weight: bold;
        }

        .pagination {
            justify-content: center;
            margin-top: 20px;
        }

        .filters {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 sidebar">
                <div class="p-3">
                    <div class="text-center mb-4">
                        <i class="fas fa-user-shield fa-3x text-primary mb-2"></i>
                        <h5 id="nombreAdmin">Administrador</h5>
                        <small class="text-muted">Admin</small>
                    </div>
                    <nav class="nav flex-column">
                        <a class="nav-link active" href="#" data-section="dashboard">
                            <i class="fas fa-tachometer-alt me-2"></i>Panel Principal
                        </a>
                        <a class="nav-link" href="#" data-section="usuarios">
                            <i class="fas fa-users me-2"></i>Usuarios
                        </a>
                        <a class="nav-link" href="#" data-section="medicos">
                            <i class="fas fa-user-md me-2"></i>Médicos
                        </a>
                        <a class="nav-link" href="#" data-section="citas">
                            <i class="fas fa-calendar-check me-2"></i>Citas
                        </a>
                        <a class="nav-link" href="#" data-section="reportes">
                            <i class="fas fa-chart-line me-2"></i>Reportes
                        </a>
                        <hr>
                        <a class="nav-link text-danger" href="#" onclick="cerrarSesion()">
                            <i class="fas fa-sign-out-alt me-2"></i>Cerrar Sesión
                        </a>
                    </nav>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10">
                <div class="main-content">
                    <!-- Dashboard Section -->
                    <div id="dashboard" class="content-section">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2><i class="fas fa-tachometer-alt text-primary me-2"></i>Panel Principal</h2>
                            <span class="badge bg-primary p-2" id="fechaActual"></span>
                        </div>
                        <div class="loading" id="dashboardLoading">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p>Cargando estadísticas...</p>
                        </div>
                        <div class="row mb-4" id="dashboardStats" style="display: none;">
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <i class="fas fa-users fa-2x text-primary mb-2"></i>
                                        <h3 class="text-primary" id="totalPacientes">0</h3>
                                        <small class="text-muted">Pacientes</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <i class="fas fa-calendar-clock fa-2x text-warning mb-2"></i>
                                        <h3 class="text-warning" id="citasPendientes">0</h3>
                                        <small class="text-muted">Citas Pendientes</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <i class="fas fa-calendar-check fa-2x text-success mb-2"></i>
                                        <h3 class="text-success" id="citasHoy">0</h3>
                                        <small class="text-muted">Citas Hoy</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <i class="fas fa-times-circle fa-2x text-danger mb-2"></i>
                                        <h3 class="text-danger" id="citasCanceladas">0</h3>
                                        <small class="text-muted">Citas Canceladas</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Usuarios Section -->
                    <div id="usuarios" class="content-section" style="display:none;">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2><i class="fas fa-users text-primary me-2"></i>Gestión de Usuarios</h2>
                        </div>

                        <!-- Filtros -->
                        <div class="filters">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <select class="form-select" id="filtroTipoUsuario">
                                        <option value="todos">Todos los roles</option>
                                        <option value="paciente">Pacientes</option>
                                        <option value="medico">Médicos</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <select class="form-select" id="filtroEstadoUsuario">
                                        <option value="todos">Todos los estados</option>
                                        <option value="activo">Activos</option>
                                        <option value="inactivo">Inactivos</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-primary" onclick="cargarUsuarios()">
                                        <i class="fas fa-search"></i> Filtrar
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="loading" id="usuariosLoading">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p>Cargando usuarios...</p>
                        </div>

                        <div id="usuariosContainer" class="fade-in">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Nombre</th>
                                            <th>Correo</th>
                                            <th>Documento</th>
                                            <th>Teléfono</th>
                                            <th>Rol</th>
                                            <th>Estado</th>
                                            <th>Fecha Registro</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tablaUsuarios">
                                        <!-- Usuarios se cargan dinámicamente -->
                                    </tbody>
                                </table>
                            </div>
                            <nav id="paginacionUsuarios"></nav>
                        </div>
                    </div>

                    <!-- Médicos Section -->
                    <div id="medicos" class="content-section" style="display:none;">
                        <h2><i class="fas fa-user-md text-primary me-2"></i>Gestión de Médicos</h2>

                        <!-- Crear Especialidad -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5><i class="fas fa-stethoscope me-2"></i>Crear Especialidad</h5>
                            </div>
                            <div class="card-body">
                                <form id="formCrearEspecialidad" onsubmit="crearEspecialidad(event)">
                                    <div class="row g-3">
                                        <div class="col-md-8">
                                            <input type="text" class="form-control" id="nuevaEspecialidad"
                                                placeholder="Nombre de la especialidad" required>
                                        </div>
                                        <div class="col-md-4">
                                            <button class="btn btn-primary" type="submit">
                                                <i class="fas fa-plus"></i> Agregar
                                            </button>
                                        </div>
                                    </div>
                                </form>
                                <div class="mt-3">
                                    <strong>Especialidades disponibles:</strong>
                                    <div id="listaEspecialidades" class="mt-2">
                                        <!-- Se cargan dinámicamente -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Crear Médico -->
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-user-plus me-2"></i>Crear Médico</h5>
                            </div>
                            <div class="card-body">
                                <form id="formCrearMedico" onsubmit="crearMedico(event)">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Nombre completo *</label>
                                            <input type="text" id="medicoNombre" class="form-control" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Correo</label>
                                            <input type="email" id="medicoCorreo" class="form-control">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Registro profesional *</label>
                                            <input type="text" id="medicoRegistro" class="form-control" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Teléfono</label>
                                            <input type="text" id="medicoTelefono" class="form-control">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Consultorio</label>
                                            <input type="text" id="medicoConsultorio" class="form-control">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Años de experiencia</label>
                                            <input type="number" id="medicoExp" class="form-control" min="0">
                                        </div>
                                        <div class="col-md-12">
                                            <label class="form-label">Especialidades *</label>
                                            <select id="medicoEspecialidades" class="form-select" multiple required>
                                                <!-- Se cargan dinámicamente -->
                                            </select>
                                            <small class="text-muted">Mantén Ctrl presionado para seleccionar múltiples
                                                especialidades</small>
                                        </div>
                                        <div class="col-md-12">
                                            <label class="form-label">Biografía</label>
                                            <textarea id="medicoBio" class="form-control" rows="3"></textarea>
                                        </div>
                                        <div class="col-md-12">
                                            <label class="form-label">URL de foto</label>
                                            <input type="url" id="medicoFoto" class="form-control">
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <button class="btn btn-primary" type="submit">
                                            <i class="fas fa-save"></i> Crear Médico
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Citas Section -->
                    <div id="citas" class="content-section" style="display:none;">
                        <h2><i class="fas fa-calendar-check text-primary me-2"></i>Gestión de Citas</h2>

                        <!-- Filtros de citas -->
                        <div class="filters">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <select class="form-select" id="filtroEstadoCita">
                                        <option value="todos">Todos los estados</option>
                                        <option value="pendiente">Pendientes</option>
                                        <option value="confirmada">Confirmadas</option>
                                        <option value="realizada">Realizadas</option>
                                        <option value="cancelada">Canceladas</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <input type="date" class="form-control" id="fechaInicioCitas">
                                </div>
                                <div class="col-md-3">
                                    <input type="date" class="form-control" id="fechaFinCitas">
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-primary" onclick="cargarCitas()">
                                        <i class="fas fa-search"></i> Filtrar
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="loading" id="citasLoading">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p>Cargando citas...</p>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Paciente</th>
                                        <th>Médico</th>
                                        <th>Fecha</th>
                                        <th>Hora</th>
                                        <th>Motivo</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaCitas">
                                    <!-- Citas se cargan dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                        <nav id="paginacionCitas"></nav>
                    </div>

                    <!-- Reportes Section -->
                    <div id="reportes" class="content-section" style="display:none;">
                        <h2><i class="fas fa-chart-line text-primary me-2"></i>Reportes</h2>

                        <div class="row mb-4">
                            <div class="col-md-4">
                                <select class="form-select" id="tipoReporte">
                                    <option value="citas_especialidad">Citas por Especialidad</option>
                                    <option value="no_asistencia">Tasa de No Asistencia</option>
                                    <option value="citas_mensuales">Citas Mensuales</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <input type="date" class="form-control" id="fechaInicioReporte">
                            </div>
                            <div class="col-md-3">
                                <input type="date" class="form-control" id="fechaFinReporte">
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-primary" onclick="generarReporte()">
                                    <i class="fas fa-chart-bar"></i> Generar
                                </button>
                            </div>
                        </div>

                        <div class="loading" id="reportesLoading">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p>Generando reporte...</p>
                        </div>

                        <div id="reporteContainer">
                            <!-- El reporte se carga aquí dinámicamente -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para cancelar cita -->
    <div class="modal fade" id="modalCancelarCita" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Cancelar Cita</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Motivo de cancelación:</label>
                        <textarea class="form-control" id="motivoCancelacion" rows="3"
                            placeholder="Ingrese el motivo de la cancelación..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-danger" onclick="confirmarCancelacion()">Cancelar Cita</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        // Configuración de la API
        const API_BASE_URL = 'http://localhost:3000';
        let currentUser = null;
        let citaACancelar = null;

        // Función para obtener token
        function getToken() {
            return localStorage.getItem('token');
        }

        // Headers para las peticiones
        function getHeaders() {
            const token = getToken();
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };
        }

        // Verificar autenticación
        function verificarAuth() {
            const token = getToken();
            if (!token) {
                window.location.href = '../Acceso.html';
                return false;
            }

            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                if (payload.exp * 1000 < Date.now()) {
                    localStorage.removeItem('token');
                    window.location.href = '../Acceso.html';
                    return false;
                }

                currentUser = payload;
                console.log('Usuario autenticado:', currentUser);
                return true;
            } catch (error) {
                console.error('Error verificando token:', error);
                localStorage.removeItem('token');
                window.location.href = '../Acceso.html';
                return false;
            }
        }

        // Inicialización
        document.addEventListener('DOMContentLoaded', function () {
            if (!verificarAuth()) {
                return;
            }
            inicializarPanel();
        });

        function inicializarPanel() {
            document.getElementById('fechaActual').innerText = new Date().toLocaleDateString('es-ES');
            cargarDashboard();
            cargarEspecialidades();
            configurarNavegacion();
        }

        // Navegación entre secciones
        function configurarNavegacion() {
            const links = document.querySelectorAll('.nav-link[data-section]');
            const sections = document.querySelectorAll('.content-section');

            links.forEach(link => {
                link.addEventListener('click', e => {
                    e.preventDefault();
                    const target = link.dataset.section;

                    sections.forEach(sec => sec.style.display = 'none');
                    document.getElementById(target).style.display = 'block';
                    links.forEach(l => l.classList.remove('active'));
                    link.classList.add('active');

                    // Cargar datos según la sección
                    switch (target) {
                        case 'usuarios':
                            cargarUsuarios();
                            break;
                        case 'citas':
                            cargarCitas();
                            break;
                    }
                });
            });
        }

        // Dashboard
        async function cargarDashboard() {
            const loading = document.getElementById('dashboardLoading');
            const stats = document.getElementById('dashboardStats');

            loading.style.display = 'block';
            stats.style.display = 'none';

            try {
                const response = await fetch(`${API_BASE_URL}/admin/dashboard`, {
                    headers: getHeaders()
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    const estadisticas = data.data.stats;
                    document.getElementById('totalPacientes').textContent = estadisticas.total_pacientes || 0;
                    document.getElementById('citasPendientes').textContent = estadisticas.citas_pendientes || 0;
                    document.getElementById('citasHoy').textContent = estadisticas.citas_hoy || 0;
                    document.getElementById('citasCanceladas').textContent = estadisticas.citas_canceladas || 0;
                } else {
                    throw new Error(data.message || 'Error en la respuesta');
                }
            } catch (error) {
                console.error('Error al cargar dashboard:', error);
                mostrarAlerta('Error al cargar las estadísticas: ' + error.message, 'danger');
            } finally {
                loading.style.display = 'none';
                stats.style.display = 'flex';
            }
        }

        // Usuarios
        async function cargarUsuarios(page = 1) {
            const loading = document.getElementById('usuariosLoading');
            const container = document.getElementById('usuariosContainer');

            loading.style.display = 'block';

            try {
                const tipo = document.getElementById('filtroTipoUsuario')?.value || 'todos';
                const estado = document.getElementById('filtroEstadoUsuario')?.value || 'todos';

                const params = new URLSearchParams({
                    page,
                    limit: 10,
                    tipo,
                    estado
                });

                const response = await fetch(`${API_BASE_URL}/admin/usuarios?${params}`, {
                    headers: getHeaders()
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    renderizarUsuarios(data.data.users);
                    renderizarPaginacion(data.data.pagination, 'paginacionUsuarios', cargarUsuarios);
                } else {
                    throw new Error(data.message || 'Error en la respuesta');
                }
            } catch (error) {
                console.error('Error al cargar usuarios:', error);
                mostrarAlerta('Error al cargar usuarios: ' + error.message, 'danger');
            } finally {
                loading.style.display = 'none';
            }
        }

        function renderizarUsuarios(usuarios) {
            const tbody = document.getElementById('tablaUsuarios');
            tbody.innerHTML = '';

            if (!usuarios || usuarios.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">No se encontraron usuarios</td></tr>';
                return;
            }

            usuarios.forEach(usuario => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${usuario.nombre_completo || 'N/A'}</td>
                    <td>${usuario.correo}</td>
                    <td>${usuario.documento || 'N/A'}</td>
                    <td>${usuario.telefono || 'N/A'}</td>
                    <td><span class="badge bg-info">${usuario.rol}</span></td>
                    <td><span class="status-${usuario.activo ? 'activo' : 'inactivo'}">${usuario.activo ? 'Activo' : 'Inactivo'}</span></td>
                    <td>${new Date(usuario.created_at).toLocaleDateString('es-ES')}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-${usuario.activo ? 'warning' : 'success'}" 
                                    onclick="toggleUsuario(${usuario.id_usuario}, ${!usuario.activo})">
                                ${usuario.activo ? 'Desactivar' : 'Activar'}
                            </button>
                            <button class="btn btn-danger" onclick="eliminarUsuario(${usuario.id_usuario})">
                                Eliminar
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function toggleUsuario(id, activar) {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/usuarios/${id}/estado`, {
                    method: 'PUT',
                    headers: getHeaders(),
                    body: JSON.stringify({ activo: activar })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    mostrarAlerta(data.message, 'success');
                    cargarUsuarios();
                } else {
                    throw new Error(data.message || 'Error en la respuesta');
                }
            } catch (error) {
                console.error('Error al cambiar estado:', error);
                mostrarAlerta('Error al cambiar estado del usuario: ' + error.message, 'danger');
            }
        }

        async function eliminarUsuario(id) {
            if (!confirm('¿Estás seguro de eliminar este usuario? Esta acción no se puede deshacer.')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/admin/usuarios/${id}`, {
                    method: 'DELETE',
                    headers: getHeaders()
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    mostrarAlerta(data.message, 'success');
                    cargarUsuarios();
                } else {
                    throw new Error(data.message || 'Error en la respuesta');
                }
            } catch (error) {
                console.error('Error al eliminar usuario:', error);
                mostrarAlerta('Error al eliminar usuario: ' + error.message, 'danger');
            }
        }

        // Especialidades
        async function cargarEspecialidades() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/especialidades`, {
                    headers: getHeaders()
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    renderizarEspecialidades(data.data);
                } else {
                    throw new Error(data.message || 'Error en la respuesta');
                }
            } catch (error) {
                console.error('Error al cargar especialidades:', error);
                mostrarAlerta('Error al cargar especialidades: ' + error.message, 'danger');
            }
        }

        function renderizarEspecialidades(especialidades) {
            const lista = document.getElementById('listaEspecialidades');
            const select = document.getElementById('medicoEspecialidades');

            lista.innerHTML = '';
            select.innerHTML = '';

            if (!especialidades || especialidades.length === 0) {
                lista.innerHTML = '<span class="text-muted">No hay especialidades disponibles</span>';
                return;
            }

            especialidades.forEach(esp => {
                // Lista visual
                const badge = document.createElement('span');
                badge.className = 'badge bg-primary me-2 mb-2';
                badge.textContent = esp.nombre;
                lista.appendChild(badge);

                // Select para el formulario
                const option = document.createElement('option');
                option.value = esp.id_especialidad;
                option.textContent = esp.nombre;
                select.appendChild(option);
            });
        }

        async function crearEspecialidad(event) {
            event.preventDefault();

            const nombre = document.getElementById('nuevaEspecialidad').value.trim();
            if (!nombre) return;

            try {
                const response = await fetch(`${API_BASE_URL}/admin/especialidades`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({ nombre })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    mostrarAlerta(data.message, 'success');
                    document.getElementById('nuevaEspecialidad').value = '';
                    cargarEspecialidades();
                } else {
                    throw new Error(data.message || 'Error en la respuesta');
                }
            } catch (error) {
                console.error('Error al crear especialidad:', error);
                mostrarAlerta('Error al crear especialidad: ' + error.message, 'danger');
            }
        }

        // Médicos
        async function crearMedico(event) {
            event.preventDefault();

            const especialidadesSelect = document.getElementById('medicoEspecialidades');
            const especialidades = Array.from(especialidadesSelect.selectedOptions).map(opt => parseInt(opt.value));

            if (especialidades.length === 0) {
                mostrarAlerta('Seleccione al menos una especialidad', 'warning');
                return;
            }

            const medicoData = {
                nombre_completo: document.getElementById('medicoNombre').value.trim(),
                correo: document.getElementById('medicoCorreo').value.trim() || null,
                registro_profesional: document.getElementById('medicoRegistro').value.trim(),
                consultorio: document.getElementById('medicoConsultorio').value.trim() || null,
                telefono: document.getElementById('medicoTelefono').value.trim() || null,
                biografia: document.getElementById('medicoBio').value.trim() || null,
                experiencia_anos: parseInt(document.getElementById('medicoExp').value) || null,
                foto_url: document.getElementById('medicoFoto').value.trim() || null,
                especialidades
            };

            try {
                const response = await fetch(`${API_BASE_URL}/admin/medicos`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify(medicoData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    mostrarAlerta(data.message, 'success');
                    document.getElementById('formCrearMedico').reset();
                } else {
                    throw new Error(data.message || 'Error en la respuesta');
                }
            } catch (error) {
                console.error('Error al crear médico:', error);
                mostrarAlerta('Error al crear médico: ' + error.message, 'danger');
            }
        }

        // Citas
        async function cargarCitas(page = 1) {
            const loading = document.getElementById('citasLoading');
            loading.style.display = 'block';

            try {
                const estado = document.getElementById('filtroEstadoCita')?.value || 'todos';
                const fechaInicio = document.getElementById('fechaInicioCitas')?.value || '';
                const fechaFin = document.getElementById('fechaFinCitas')?.value || '';

                const params = new URLSearchParams({
                    page,
                    limit: 10,
                    estado,
                    fecha_inicio: fechaInicio,
                    fecha_fin: fechaFin
                });

                const response = await fetch(`${API_BASE_URL}/admin/citas?${params}`, {
                    headers: getHeaders()
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    renderizarCitas(data.data.citas);
                    renderizarPaginacion(data.data.pagination, 'paginacionCitas', cargarCitas);
                } else {
                    throw new Error(data.message || 'Error en la respuesta');
                }
            } catch (error) {
                console.error('Error al cargar citas:', error);
                mostrarAlerta('Error al cargar citas: ' + error.message, 'danger');
            } finally {
                loading.style.display = 'none';
            }
        }

        function renderizarCitas(citas) {
            const tbody = document.getElementById('tablaCitas');
            tbody.innerHTML = '';

            if (!citas || citas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">No se encontraron citas</td></tr>';
                return;
            }

            citas.forEach(cita => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${cita.paciente || 'N/A'}</td>
                    <td>${cita.medico || 'N/A'}</td>
                    <td>${new Date(cita.fecha).toLocaleDateString('es-ES')}</td>
                    <td>${cita.hora_inicio} - ${cita.hora_fin}</td>
                    <td>${cita.motivo || 'N/A'}</td>
                    <td><span class="status-${(cita.estado || 'pendiente').toLowerCase().replace(' ', '_')}">${cita.estado || 'Pendiente'}</span></td>
                    <td>
                        ${cita.estado !== 'Cancelada' && cita.estado !== 'cancelada' ?
                        `<button class="btn btn-danger btn-sm" onclick="abrirModalCancelar(${cita.id_cita})">
                                <i class="fas fa-times"></i> Cancelar
                            </button>` :
                        '<span class="text-muted">Cancelada</span>'
                    }
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function abrirModalCancelar(idCita) {
            citaACancelar = idCita;
            const modal = new bootstrap.Modal(document.getElementById('modalCancelarCita'));
            modal.show();
        }

        async function confirmarCancelacion() {
            if (!citaACancelar) return;

            const motivo = document.getElementById('motivoCancelacion').value.trim();

            try {
                const response = await fetch(`${API_BASE_URL}/admin/citas/${citaACancelar}/cancelar`, {
                    method: 'PUT',
                    headers: getHeaders(),
                    body: JSON.stringify({ motivo })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    mostrarAlerta(data.message, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('modalCancelarCita')).hide();
                    document.getElementById('motivoCancelacion').value = '';
                    cargarCitas();
                } else {
                    throw new Error(data.message || 'Error en la respuesta');
                }
            } catch (error) {
                console.error('Error al cancelar cita:', error);
                mostrarAlerta('Error al cancelar cita: ' + error.message, 'danger');
            }

            citaACancelar = null;
        }

        // Reportes
        async function generarReporte() {
            const loading = document.getElementById('reportesLoading');
            const container = document.getElementById('reporteContainer');

            loading.style.display = 'block';
            container.innerHTML = '';

            const tipo = document.getElementById('tipoReporte').value;
            const fechaInicio = document.getElementById('fechaInicioReporte').value;
            const fechaFin = document.getElementById('fechaFinReporte').value;

            try {
                const params = new URLSearchParams({
                    tipo,
                    fecha_inicio: fechaInicio,
                    fecha_fin: fechaFin
                });

                const response = await fetch(`${API_BASE_URL}/admin/reportes?${params}`, {
                    headers: getHeaders()
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    renderizarReporte(data.data, tipo);
                } else {
                    throw new Error(data.message || 'Error en la respuesta');
                }
            } catch (error) {
                console.error('Error al generar reporte:', error);
                mostrarAlerta('Error al generar reporte: ' + error.message, 'danger');
            } finally {
                loading.style.display = 'none';
            }
        }

        function renderizarReporte(datos, tipo) {
            const container = document.getElementById('reporteContainer');

            if (!datos || datos.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No hay datos disponibles para el reporte seleccionado.</div>';
                return;
            }

            let html = '<div class="table-responsive"><table class="table table-striped">';

            switch (tipo) {
                case 'citas_especialidad':
                    html += `
                        <thead class="table-dark">
                            <tr>
                                <th>Especialidad</th>
                                <th>Total Citas</th>
                                <th>Realizadas</th>
                                <th>Canceladas</th>
                                <th>No Asistió</th>
                            </tr>
                        </thead>
                        <tbody>
                    `;
                    datos.forEach(item => {
                        html += `
                            <tr>
                                <td>${item.especialidad || 'N/A'}</td>
                                <td>${item.total_citas || 0}</td>
                                <td class="text-success">${item.realizadas || 0}</td>
                                <td class="text-danger">${item.canceladas || 0}</td>
                                <td class="text-warning">${item.no_asistio || 0}</td>
                            </tr>
                        `;
                    });
                    break;

                case 'no_asistencia':
                    html += `
                        <thead class="table-dark">
                            <tr>
                                <th>Médico</th>
                                <th>Total Citas</th>
                                <th>No Asistió</th>
                                <th>Tasa No Asistencia (%)</th>
                            </tr>
                        </thead>
                        <tbody>
                    `;
                    datos.forEach(item => {
                        html += `
                            <tr>
                                <td>${item.medico || 'N/A'}</td>
                                <td>${item.total_citas || 0}</td>
                                <td class="text-warning">${item.no_asistio || 0}</td>
                                <td class="text-danger">${item.tasa_no_asistencia || 0}%</td>
                            </tr>
                        `;
                    });
                    break;

                case 'citas_mensuales':
                    html += `
                        <thead class="table-dark">
                            <tr>
                                <th>Mes</th>
                                <th>Total Citas</th>
                                <th>Realizadas</th>
                                <th>Canceladas</th>
                            </tr>
                        </thead>
                        <tbody>
                    `;
                    datos.forEach(item => {
                        html += `
                            <tr>
                                <td>${item.mes || 'N/A'}</td>
                                <td>${item.total_citas || 0}</td>
                                <td class="text-success">${item.realizadas || 0}</td>
                                <td class="text-danger">${item.canceladas || 0}</td>
                            </tr>
                        `;
                    });
                    break;
            }

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // Paginación
        function renderizarPaginacion(pagination, containerId, callback) {
            const container = document.getElementById(containerId);
            if (!container || !pagination) return;

            let html = '<ul class="pagination">';

            // Botón anterior
            html += `
                <li class="page-item ${pagination.page === 1 ? 'disabled' : ''}">
                    <button class="page-link" onclick="${callback.name}(${pagination.page - 1})" ${pagination.page === 1 ? 'disabled' : ''}>
                        Anterior
                    </button>
                </li>
            `;

            // Páginas
            for (let i = 1; i <= pagination.pages; i++) {
                if (i === pagination.page ||
                    i === 1 ||
                    i === pagination.pages ||
                    (i >= pagination.page - 1 && i <= pagination.page + 1)) {

                    html += `
                        <li class="page-item ${i === pagination.page ? 'active' : ''}">
                            <button class="page-link" onclick="${callback.name}(${i})">${i}</button>
                        </li>
                    `;
                } else if (i === pagination.page - 2 || i === pagination.page + 2) {
                    html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                }
            }

            // Botón siguiente
            html += `
                <li class="page-item ${pagination.page === pagination.pages ? 'disabled' : ''}">
                    <button class="page-link" onclick="${callback.name}(${pagination.page + 1})" ${pagination.page === pagination.pages ? 'disabled' : ''}>
                        Siguiente
                    </button>
                </li>
            `;

            html += '</ul>';
            container.innerHTML = html;
        }

        // Utilidades
        function mostrarAlerta(mensaje, tipo = 'info') {
            // Remover alertas anteriores
            document.querySelectorAll('.alert').forEach(alert => alert.remove());

            const alertContainer = document.createElement('div');
            alertContainer.className = `alert alert-${tipo} alert-dismissible fade show`;
            alertContainer.innerHTML = `
                ${mensaje}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            const mainContent = document.querySelector('.main-content');
            mainContent.insertBefore(alertContainer, mainContent.firstChild);

            // Auto-remover después de 5 segundos
            setTimeout(() => {
                if (alertContainer.parentNode) {
                    alertContainer.remove();
                }
            }, 5000);
        }

        function cerrarSesion() {
            if (confirm('¿Estás seguro de cerrar sesión?')) {
                localStorage.removeItem('token');
                window.location.href = '../Acceso.html';
            }
        }

        // Auto-refresh cada 5 minutos para el dashboard
        setInterval(() => {
            const dashboardSection = document.getElementById('dashboard');
            if (dashboardSection && dashboardSection.style.display !== 'none') {
                cargarDashboard();
            }
        }, 300000); // 5 minutos

        // Manejo de conexión perdida
        window.addEventListener('online', function () {
            mostrarAlerta('Conexión restaurada', 'success');
            cargarDashboard();
        });

        window.addEventListener('offline', function () {
            mostrarAlerta('Conexión perdida. Algunas funciones pueden no estar disponibles.', 'warning');
        });
    </script>
</body>

</html>